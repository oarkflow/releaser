# Releaser configuration for Ruby projects
# Supports Ruby CLI tools, gems, and Rails applications

version: 2

project_name: myapp-ruby

defaults:
  homepage: https://github.com/user/myapp-ruby
  description: A Ruby application built with Releaser
  license: MIT
  maintainer: developer@example.com

env:
  - BUNDLE_DEPLOYMENT=true
  - RAILS_ENV=production

variables:
  owner: user
  repo: myapp-ruby
  ruby_version: "3.2"

before:
  hooks:
    - cmd: bundle install
    - cmd: bundle exec rake test

builds:
  - id: ruby-gem
    builder: custom
    command: gem build myapp.gemspec -o ./dist/myapp-{{ .Version }}.gem
    dir: .

  # For CLI tools using Ruby Packer (rubyc)
  - id: ruby-native
    builder: custom
    command: |
      rubyc bin/myapp \
        -o ./dist/{{ .Os }}_{{ .Arch }}/myapp{{ if eq .Os "windows" }}.exe{{ end }} \
        --make-args="-j4"
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
    ignore:
      - goos: windows
        goarch: arm64

archives:
  - id: native
    builds:
      - ruby-native
    format: tar.gz
    format_overrides:
      - goos: windows
        format: zip
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    files:
      - LICENSE*
      - README*

# Publish to RubyGems
gems:
  - id: rubygems
    gemspec: myapp.gemspec
    # API key from GEM_HOST_API_KEY environment variable

nfpms:
  - id: ruby-packages
    package_name: myapp-ruby
    file_name_template: "{{ .PackageName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    vendor: MyCompany
    maintainer: developer@example.com
    description: A Ruby CLI application
    license: MIT
    formats:
      - deb
      - rpm
    dependencies:
      - ruby >= 3.0
    contents:
      - src: ./dist/linux_amd64/myapp
        dst: /usr/bin/myapp
        type: file

dockers:
  - id: ruby-docker
    image_templates:
      - "ghcr.io/{{ .Env.GITHUB_OWNER }}/{{ .ProjectName }}:{{ .Version }}"
      - "ghcr.io/{{ .Env.GITHUB_OWNER }}/{{ .ProjectName }}:latest"
    dockerfile: Dockerfile
    extra_files:
      - Gemfile
      - Gemfile.lock

checksum:
  name_template: "checksums.txt"
  algorithm: sha256

changelog:
  use: github
  sort: asc
  filters:
    exclude:
      - "^docs:"
      - "^test:"
  groups:
    - title: Features
      regexp: "^feat:"
    - title: Bug Fixes
      regexp: "^fix:"

release:
  github:
    owner: "{{ .Env.GITHUB_OWNER }}"
    name: "{{ .Env.GITHUB_REPO }}"
  draft: false
  prerelease: auto

brews:
  - name: myapp-ruby
    description: A Ruby CLI application
    homepage: https://github.com/user/myapp-ruby
    license: MIT
    repository:
      owner: user
      name: homebrew-tap
    dependencies:
      - name: ruby
        version: "3.2"
    install: |
      bin.install "myapp"
    test: |
      system "#{bin}/myapp", "--version"
