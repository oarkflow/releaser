# Releaser configuration for .NET/C# projects
# Supports console apps, web APIs, and class libraries

version: 2

project_name: myapp-dotnet

defaults:
  homepage: https://github.com/user/myapp-dotnet
  description: A .NET application built with Releaser
  license: MIT
  maintainer: developer@example.com
  vendor: MyCompany

env:
  - DOTNET_CLI_TELEMETRY_OPTOUT=1
  - DOTNET_NOLOGO=1

variables:
  owner: user
  repo: myapp-dotnet
  framework: net8.0

before:
  hooks:
    - cmd: dotnet restore
    - cmd: dotnet test --no-restore

builds:
  - id: dotnet-app
    builder: custom
    command: |
      dotnet publish -c Release \
        -r {{ .Os }}-{{ if eq .Arch "amd64" }}x64{{ else if eq .Arch "arm64" }}arm64{{ else }}x86{{ end }} \
        -p:PublishSingleFile=true \
        -p:PublishTrimmed=true \
        -p:Version={{ .Version }} \
        -o ./dist/{{ .Os }}_{{ .Arch }}
    dir: src/MyApp
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ignore:
      - goos: windows
        goarch: arm64

archives:
  - id: default
    format: tar.gz
    format_overrides:
      - goos: windows
        format: zip
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    files:
      - LICENSE*
      - README*
      - appsettings*.json

nfpms:
  - id: dotnet-packages
    package_name: myapp-dotnet
    file_name_template: "{{ .PackageName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    vendor: MyCompany
    homepage: "{{ .Env.HOMEPAGE }}"
    maintainer: "developer@example.com"
    description: "A .NET application"
    license: MIT
    formats:
      - deb
      - rpm
    dependencies:
      - dotnet-runtime-8.0
    contents:
      - src: ./dist/linux_amd64/myapp
        dst: /usr/bin/myapp
        type: file
      - src: ./config/appsettings.json
        dst: /etc/myapp/appsettings.json
        type: config
      - src: ./systemd/myapp.service
        dst: /lib/systemd/system/myapp.service
        type: file

# Publish NuGet packages for class libraries
nugets:
  - id: nuget-publish
    source: https://api.nuget.org/v3/index.json
    # API key from NUGET_API_KEY environment variable

# Docker for web APIs
dockers:
  - id: dotnet-docker
    image_templates:
      - "ghcr.io/{{ .Env.GITHUB_OWNER }}/{{ .ProjectName }}:{{ .Version }}"
      - "ghcr.io/{{ .Env.GITHUB_OWNER }}/{{ .ProjectName }}:latest"
    dockerfile: Dockerfile
    use: buildx
    build_flag_templates:
      - "--platform=linux/amd64,linux/arm64"
      - "--label=org.opencontainers.image.title={{ .ProjectName }}"
      - "--label=org.opencontainers.image.version={{ .Version }}"

checksum:
  name_template: "checksums.txt"
  algorithm: sha256

changelog:
  use: github
  sort: asc
  groups:
    - title: Features
      regexp: "^feat:"
    - title: Bug Fixes
      regexp: "^fix:"
    - title: Performance
      regexp: "^perf:"

release:
  github:
    owner: "{{ .Env.GITHUB_OWNER }}"
    name: "{{ .Env.GITHUB_REPO }}"
  draft: false
  prerelease: auto

chocolateys:
  - name: myapp-dotnet
    title: My .NET App
    authors: Developer
    project_url: https://github.com/user/myapp-dotnet
    summary: A .NET application
    description: A full-featured .NET application
    tags: dotnet csharp cli utility
    skip_publish: "{{ if .IsSnapshot }}true{{ end }}"

wingets:
  - name: myapp-dotnet
    publisher: MyCompany
    publisher_url: https://mycompany.com
    short_description: A .NET application
    license: MIT
    package_identifier: MyCompany.MyAppDotnet
