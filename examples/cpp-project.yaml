# Releaser configuration for C/C++ projects
# Supports CMake, Make, Meson, and Autotools builds

version: 2

project_name: myapp-cpp

defaults:
  homepage: https://github.com/user/myapp-cpp
  description: A C++ application built with Releaser
  license: MIT
  maintainer: developer@example.com

env:
  - CC=gcc
  - CXX=g++
  - CMAKE_BUILD_TYPE=Release

variables:
  owner: user
  repo: myapp-cpp

before:
  hooks:
    - cmd: mkdir -p build
    - cmd: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
    - cmd: cmake --build build --parallel

builds:
  # CMake-based builds
  - id: cpp-cmake
    builder: custom
    command: |
      mkdir -p build-{{ .Os }}-{{ .Arch }}
      cmake -B build-{{ .Os }}-{{ .Arch }} -S . \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_SYSTEM_NAME={{ if eq .Os "linux" }}Linux{{ else if eq .Os "darwin" }}Darwin{{ else }}Windows{{ end }} \
        -DCMAKE_SYSTEM_PROCESSOR={{ if eq .Arch "amd64" }}x86_64{{ else }}aarch64{{ end }}
      cmake --build build-{{ .Os }}-{{ .Arch }} --parallel
      mkdir -p ./dist/{{ .Os }}_{{ .Arch }}
      cp build-{{ .Os }}-{{ .Arch }}/myapp{{ if eq .Os "windows" }}.exe{{ end }} ./dist/{{ .Os }}_{{ .Arch }}/
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ignore:
      - goos: windows
        goarch: arm64

  # Cross-compile for embedded/ARM using Make
  - id: cpp-arm-embedded
    builder: custom
    command: |
      make CROSS_COMPILE=arm-linux-gnueabihf- TARGET=arm
      mkdir -p ./dist/linux_arm
      cp myapp ./dist/linux_arm/
    goos:
      - linux
    goarch:
      - arm
    goarm:
      - "7"

# Use UPX to compress binaries
upx:
  - enabled: true
    ids:
      - cpp-cmake
    compress: best
    lzma: true
    goos:
      - linux
      - windows
    goarch:
      - amd64

archives:
  - id: default
    format: tar.gz
    format_overrides:
      - goos: windows
        format: zip
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    files:
      - LICENSE*
      - README*
      - include/**/*
    wrap_in_directory: true

nfpms:
  - id: cpp-packages
    package_name: myapp-cpp
    file_name_template: "{{ .PackageName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    vendor: MyCompany
    maintainer: developer@example.com
    description: A C++ application
    license: MIT
    formats:
      - deb
      - rpm
      - apk
    dependencies:
      - libstdc++6
      - libc6
    recommends:
      - libssl3
    contents:
      - src: ./dist/linux_amd64/myapp
        dst: /usr/bin/myapp
        type: file
      - src: ./include
        dst: /usr/include/myapp
        type: tree
      - src: ./lib/libmyapp.so
        dst: /usr/lib/libmyapp.so
        type: file
    scripts:
      postinstall: scripts/postinstall.sh
      preremove: scripts/preremove.sh

# Windows installer using NSIS
nsiss:
  - id: windows-installer
    name: MyApp C++
    installer_name: "myapp-cpp-{{ .Version }}-setup"
    install_dir: "$PROGRAMFILES\\MyApp"
    request_execution_level: admin
    contents:
      - src: ./dist/windows_amd64/myapp.exe
        dst: myapp.exe
      - src: ./dll/*.dll
        dst: .
      - src: ./README.md
        dst: README.txt
    scripts:
      install: |
        CreateShortCut "$DESKTOP\MyApp.lnk" "$INSTDIR\myapp.exe"
        CreateShortCut "$SMPROGRAMS\MyApp.lnk" "$INSTDIR\myapp.exe"
      uninstall: |
        Delete "$DESKTOP\MyApp.lnk"
        Delete "$SMPROGRAMS\MyApp.lnk"

# Flatpak for Linux desktop
flatpaks:
  - id: cpp-flatpak
    runtime: org.freedesktop.Platform
    runtime_version: "23.08"
    sdk: org.freedesktop.Sdk
    app_id: com.mycompany.myapp
    branch: stable
    command: myapp
    finish_args:
      - "--share=network"
      - "--socket=wayland"
      - "--socket=fallback-x11"
    modules:
      - myapp

# AppImage for portable Linux distribution
appimages:
  - id: cpp-appimage
    name: MyApp
    icon: assets/icon.png
    desktop_file: assets/myapp.desktop
    categories: "Utility"

dockers:
  - id: cpp-docker
    image_templates:
      - "ghcr.io/{{ .Env.GITHUB_OWNER }}/{{ .ProjectName }}:{{ .Version }}"
      - "ghcr.io/{{ .Env.GITHUB_OWNER }}/{{ .ProjectName }}:latest"
    dockerfile: Dockerfile
    build_flag_templates:
      - "--build-arg=VERSION={{ .Version }}"

checksum:
  name_template: "checksums.txt"
  algorithm: sha256

signs:
  - id: gpg-sign
    cmd: gpg
    args:
      - "--batch"
      - "--local-user"
      - "{{ .Env.GPG_FINGERPRINT }}"
      - "--output"
      - "${signature}"
      - "--detach-sign"
      - "${artifact}"
    artifacts: checksum

changelog:
  use: github
  sort: asc
  groups:
    - title: Features
      regexp: "^feat:"
    - title: Bug Fixes
      regexp: "^fix:"
    - title: Performance
      regexp: "^perf:"

release:
  github:
    owner: "{{ .Env.GITHUB_OWNER }}"
    name: "{{ .Env.GITHUB_REPO }}"
  draft: false
  prerelease: auto

brews:
  - name: myapp-cpp
    description: A C++ CLI application
    homepage: https://github.com/user/myapp-cpp
    license: MIT
    repository:
      owner: user
      name: homebrew-tap
    dependencies:
      - name: cmake
        type: build
    install: |
      system "cmake", "-B", "build", "-S", ".", *std_cmake_args
      system "cmake", "--build", "build"
      bin.install "build/myapp"
    test: |
      system "#{bin}/myapp", "--version"

aurs:
  - name: myapp-cpp
    description: A C++ CLI application
    homepage: https://github.com/user/myapp-cpp
    license: MIT
    maintainers:
    git_url: ssh://aur@aur.archlinux.org/myapp-cpp.git
    depends:
      - gcc-libs
      - glibc
    makedepends:
      - cmake
      - make
    package: |
      cd "$srcdir/$pkgname-$pkgver"
      cmake -B build -S . -DCMAKE_INSTALL_PREFIX=/usr
      cmake --build build
      DESTDIR="$pkgdir" cmake --install build

scoops:
  - name: myapp-cpp
    description: A C++ CLI application
    homepage: https://github.com/user/myapp-cpp
    license: MIT
    repository:
      owner: user
      name: scoop-bucket
